#!/bin/bash

set -eo pipefail

KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"
KUBECONFIG_DIR="$(dirname "$KUBECONFIG")"
EXTRA_ARGS=${@:1}
GOMPLATE_EXTRA_ARGS=${EXTRA_ARGS:-$GOMPLATE_EXTRA_ARGS}

mkdir -p ${KUBECONFIG_DIR}

function write_kube_config() {
	[[ "$KOPS_AWS_IAM_AUTHENTICATOR_ENABLED" == "true" ]] && template_iam_authenticator_snippet || kops_export_cfg
}

function kops_export_cfg() {
	kops export kubecfg
}

function template_iam_authenticator_snippet() {
	direnv exec ${KUBECONFIG_DIR} gomplate ${GOMPLATE_EXTRA_ARGS} -f ${KUBECONFIG_TEMPLATE} >${KUBECONFIG}
	kops_export_cfg
}

write_kube_config

echo "Wrote Kube cfg to ${KUBECONFIG}..."
