#!/bin/bash

set -eo pipefail

KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"
KUBECONFIG_DIR="$(dirname "$KUBECONFIG")"
EXTRA_ARGS=${@:1}
GOMPLATE_EXTRA_ARGS=${EXTRA_ARGS:-$GOMPLATE_EXTRA_ARGS}

mkdir -p ${KUBECONFIG_DIR}

function write_kube_config() {
	[[ "$KOPS_AWS_IAM_AUTHENTICATOR_ENABLED" == "true" ]] && template_iam_authenticator_cfg || kops_export_cfg
}

function kops_export_cfg() {
	kops export kubecfg
}

function template_iam_authenticator_cfg() {
	local KEYSET=$(mktemp)
	aws s3 cp $KOPS_STATE_STORE/$KOPS_CLUSTER_NAME/pki/issued/ca/keyset.yaml $KEYSET
	export KOPS_CERTIFICATE_AUTHORITY_DATA="$(yq r $KEYSET 'spec.keys[0].publicMaterial')"
	rm -rf $KEYSET
	direnv exec ${KUBECONFIG_DIR} gomplate ${GOMPLATE_EXTRA_ARGS} -f ${KUBECONFIG_TEMPLATE} >${KUBECONFIG}
}

write_kube_config

echo "Wrote Kube cfg to ${KUBECONFIG}..."
